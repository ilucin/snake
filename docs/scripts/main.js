"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}SnakeGame.Enums=function(){return{Direction:{UP:1,DOWN:2,RIGHT:3,LEFT:4,RELATIVE_RIGHT:5,RELATIVE_LEFT:6},Collision:{SNAKE_TO_FOOD:1,SNAKE_TO_SNAKE:2}}}(),SnakeGame.Consts=function(){return{CELL_SIZE:50,FRAME_RATE_DROP:5,EMPTY_CELL:"empty",SNAKE_CELL:"snake",FOOD_CELL:"food",MAX_CYCLE_BETWEEN_FOOD:5,MAX_FOOD:10,MAX_FOOD_DURATION:200,MIN_FOOD_DURATION:50}}(),SnakeGame.Utils=function(){function e(e,n){return Math.floor(Math.random()*(n-e)+e)}function n(n){return n[e(0,n.length)]}return{randomInt:e,pickRandom:n}}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Classes=function(){var e=function(){function e(n,t){_classCallCheck(this,e),this.x=n,this.y=t}return _createClass(e,[{key:"normalizeForDimensions",value:function(e,n){this.x%=e,this.y%=n,this.x<0&&(this.x=e+this.x),this.y<0&&(this.y=n+this.y)}},{key:"clone",value:function(){return new e(this.x,this.y)}}]),e}(),n=function e(){_classCallCheck(this,e),this._cells=[]};return{Position:e,CellCollection:n}}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.FoodController=function(){var e=SnakeGame.Consts,n=e.MAX_CYCLE_BETWEEN_FOOD,t=e.MAX_FOOD,o=e.MAX_FOOD_DURATION,i=e.MIN_FOOD_DURATION,r=SnakeGame.Utils.randomInt,a=SnakeGame.Classes.Position,s=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.className="food",e}return _inherits(n,e),n}(a),c=function(){function e(){_classCallCheck(this,e),this._food=[],this._generateNextFoodCycle()}return _createClass(e,[{key:"destroyFood",value:function(e,n){var t=this._food;t.forEach(function(o){o.cycle+o.duration<e&&(t.splice(t.indexOf(o),1),n(o))})}},{key:"generateFood",value:function(e,a,c){var l=this._food;if(e%n===this._nextFoodCycle&&l.length<t){var u=a();if(u){var f=new s(u.x,u.y);f.cycle=e,f.duration=r(i,o),l.push(f),c(f)}}this._generateNextFoodCycle()}},{key:"removeFoodUnitAt",value:function(e){for(var n=this._food,t=0;t<n.length;t++)if(n[t].x===e.x&&n[t].y===e.y)return n.splice(n.indexOf(n[t]),1),!0;return!1}},{key:"getPositions",value:function(){return this._food}},{key:"_generateNextFoodCycle",value:function(){this._nextFoodCycle=r(0,n)}}]),e}();return c}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Grid=function(){var e=SnakeGame.Consts.EMPTY_CELL,n=SnakeGame.Classes.Position,t=SnakeGame.Utils,o=t.randomInt,i=t.pickRandom,r=function(){function t(n,o){_classCallCheck(this,t),this.width=n,this.height=o;for(var i={},r=0;r<o;r++){i[r]={};for(var a=0;a<n;a++)i[r][a]=e}this._grid=i}return _createClass(t,[{key:"setCell",value:function(e,n){this._grid[e.y][e.x]=n}},{key:"getCell",value:function(e){return this._grid[e.y][e.x]}},{key:"getRandomEmptyPosition",value:function(){for(var t=void 0,r=0;r<5;r++)if(t=new n(o(0,this.width),o(0,this.height)),this.getCell(t)===e)return t;var a=this._grid;return i(Object.keys(a).reduce(function(t,o){var i=[];return Object.keys(a[o]).forEach(function(t){a[o][t]===e&&i.push(new n(t,o))}),t.concat(i)},[]))}}]),t}();return r}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Snake=function(){var e=window.SnakeGame,n=e.Enums.Direction,t=e.Classes,o=t.Position,i=t.CellCollection,r={};r[n.UP]=n.LEFT,r[n.LEFT]=n.DOWN,r[n.DOWN]=n.RIGHT,r[n.RIGHT]=n.UP;var a={};a[n.UP]=n.RIGHT,a[n.RIGHT]=n.DOWN,a[n.DOWN]=n.LEFT,a[n.LEFT]=n.UP;var s=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.className="snake",e}return _inherits(n,e),n}(o),c=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o._cells.push(new s(e.x,e.y)),o._direction=n,o._scheduledDirectionChanges=[],o}return _inherits(t,e),_createClass(t,[{key:"isValidDirectionChange",value:function(e){var t=this._direction;return e&&(e===n.UP&&t!==n.DOWN||e===n.DOWN&&t!==n.UP||e===n.RIGHT&&t!==n.LEFT||e===n.LEFT&&t!==n.RIGHT)}},{key:"updateDirection",value:function(){var e=this._scheduledDirectionChanges,n=void 0,t=void 0;do n=e.shift(),t=this.isValidDirectionChange(n);while(!t&&e.length>0);t&&(this._direction=n)}},{key:"scheduleDirectionChange",value:function(e){var t=e;e===n.RELATIVE_LEFT?t=r[this._direction]:e===n.RELATIVE_RIGHT&&(t=a[this._direction]),this._scheduledDirectionChanges.push(t)}},{key:"getTailPosition",value:function(){return this._cells[this._cells.length-1]}},{key:"getHeadPosition",value:function(){return this._cells[0]}},{key:"getPositions",value:function(){return this._cells}},{key:"getLength",value:function(){return this._cells.length}},{key:"moveInsideOfDimensions",value:function(e,t){for(var o=this._cells,i=this._direction,r=o.length-1;r>0;r--)o[r]=o[r-1].clone();var a=o[0].clone();i===n.RIGHT?a.x++:i===n.LEFT?a.x--:i===n.UP?a.y--:i===n.DOWN&&a.y++,a.normalizeForDimensions(e,t),o[0]=a}},{key:"addCellAt",value:function(e){this._cells.push(new s(e.x,e.y))}}]),t}(i);return c}(),SnakeGame.Canvas=function(){function e(){u.style.width=f*r+"px",u.style.height=h*r+"px";for(var e=document.createDocumentFragment(),n=0;n<h;n++){var t=document.createElement("div");t.classList.add("cell-row"),d[n]={};for(var o=0;o<f;o++){var i=document.createElement("div");d[n][o]={x:o,y:n,el:i,state:c},i.classList.add("cell"),i.style.width=r+"px",i.style.height=r+"px",t.appendChild(i)}e.appendChild(t)}u.appendChild(e)}function n(e){function n(){t%=100,++t%a===0&&e(),window.requestAnimationFrame(n)}var t=0;window.requestAnimationFrame(n)}function t(e,n,t,o){var i=d[n][e];i.renderCycle=o,i.state!==t&&(i.el.classList.remove(i.state),i.state=t,i.el.classList.add(t),t!==c?_.push(i):_.splice(_.indexOf(i),1))}function o(e){p++,p%=2;for(var n=e.snake.getPositions(),o=0;o<n.length;o++)t(n[o].x,n[o].y,s,p);for(var i=e.food.getPositions(),r=0;r<i.length;r++)t(i[r].x,i[r].y,l,p);for(var a=_.slice(),u=0;u<a.length;u++)a[u].renderCycle!==p&&t(a[u].x,a[u].y,c,p)}var i=SnakeGame.Consts,r=i.CELL_SIZE,a=i.FRAME_RATE_DROP,s=i.SNAKE_CELL,c=i.EMPTY_CELL,l=i.FOOD_CELL,u=document.querySelector(".canvas"),f=Math.floor(u.getBoundingClientRect().width/r),h=Math.floor(u.getBoundingClientRect().height/r),d={},_=[],p=0;return{init:e,startFrameLoop:n,render:o,screenWidth:f,screenHeight:h}}(),SnakeGame.Game=function(){function e(e,n){if(n===f){var t=E.getCell(e);if(t===d)return v.SNAKE_TO_FOOD;if(t===f)return v.SNAKE_TO_SNAKE}return E.setCell(e,n),null}function n(){var e=O.getHeadPosition();k.push({processOnCycle:L+O.getLength(),position:e.clone()}),g.removeFoodUnitAt(e)}function t(){k.forEach(function(e){e.processOnCycle===L&&(O.addCellAt(e.position),k.splice(k.indexOf(e),1))})}function o(){return e(O.getTailPosition(),h),O.moveInsideOfDimensions(E.width,E.height),e(O.getHeadPosition(),f)}function i(e){e===v.SNAKE_TO_FOOD?n():e===v.SNAKE_TO_SNAKE&&T()}function r(){g.destroyFood(L,function(n){e(n,h)}),g.generateFood(L,function(){return E.getRandomEmptyPosition()||T()},function(n){e(n,d)})}function a(e){O.scheduleDirectionChange(e)}function s(){L++,L===Number.MAX_SAFE_INTEGER&&(L=0),O.updateDirection(),i(o()),t(),r()}function c(e,n,t){return E=new y(e,n),O=new C(E.getRandomEmptyPosition(),p.RIGHT),g=new m,k=[],L=4,T=t,{snake:O,food:g,frameLoop:s,onInputMove:a}}function l(){E=null,O=null,g=null,k=null,L=null,T=null}var u=SnakeGame.Consts,f=u.SNAKE_CELL,h=u.EMPTY_CELL,d=u.FOOD_CELL,_=SnakeGame.Enums,p=_.Direction,v=_.Collision,y=SnakeGame.Grid,C=SnakeGame.Snake,m=SnakeGame.FoodController,E=void 0,O=void 0,g=void 0,k=void 0,L=void 0,T=void 0;return{start:c,destroy:l}}(),function(){function e(){l=!l,document.body.classList[l?"add":"remove"]("is-game-paused")}var n=SnakeGame.Canvas,t=n.screenWidth,o=n.screenHeight,i=n.render,r=n.init,a=n.startFrameLoop,s=SnakeGame.Enums.Direction,c=SnakeGame.Game.start,l=!1;r();var u=c(t,o,function(){location.reload()});document.querySelector(".mobile-controls__control--left").addEventListener("touchstart",function(){u.onInputMove(s.RELATIVE_LEFT)}),document.querySelector(".mobile-controls__control--right").addEventListener("touchend",function(){u.onInputMove(s.RELATIVE_RIGHT)}),document.querySelector(".mobile-controls__control--pause").addEventListener("click",function(){e()}),document.addEventListener("keydown",function(n){40===n.which?u.onInputMove(s.DOWN):39===n.which?u.onInputMove(s.RIGHT):38===n.which?u.onInputMove(s.UP):37===n.which?u.onInputMove(s.LEFT):80===n.which&&e()}),a(function(){l||(u.frameLoop(),i(u))})}();