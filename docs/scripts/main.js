"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}SnakeGame.Evented=function(){function e(e,n){if(!n)throw new Error(e)}return function(n){function t(n,t){e("ev has to be a string",n&&"string"==typeof n),e("clb has to be a function",t&&"function"==typeof t),i[n]=i[n]||[],i[n].push(t)}function o(e,n){if(e){if(i[e])if(n){var t=i[e].indexOf(n);t>=0&&i[e].splice(t,1)}else i[e]=[]}else i={}}function r(e){if(i[e]){for(var n=arguments.length,t=Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];for(var r=0;r<i[e].length;r++){var a;(a=i[e])[r].apply(a,t)}}}var i={};return Object.assign(n,{on:t,off:o,trigger:r})}}(),SnakeGame.Enums=function(){return{Direction:{UP:1,DOWN:2,RIGHT:3,LEFT:4,RELATIVE_RIGHT:5,RELATIVE_LEFT:6},Collision:{SNAKE_TO_FOOD:1,SNAKE_TO_SNAKE:2}}}(),SnakeGame.Consts=function(){return{CELL_SIZE:30,FRAME_RATE_DROP:6,EMPTY_CELL:"empty",SNAKE_CELL:"snake",FOOD_CELL:"food",MAX_CYCLE_BETWEEN_FOOD:5,MAX_FOOD:1e4,MAX_FOOD_DURATION:150,MIN_FOOD_DURATION:50,BOT_SNAKE:!0}}(),SnakeGame.Utils=function(){function e(e,n){return Math.floor(Math.random()*(n-e)+e)}function n(n){return n[e(0,n.length)]}function t(){return n(i)}function o(){return n(a)}var r=SnakeGame.Enums.Direction,i=[r.UP,r.DOWN,r.LEFT,r.RIGHT],a=["Xandra","Xavier","Xeus","Xenia","Xenon","Xena","Xerxes","Xexilia","Xadrian","Xiu"];return{randomInt:e,pickRandom:n,getRandomNonRelativeDirection:t,getRandomName:o}}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Classes=function(){return{Position:function(){function e(n,t){_classCallCheck(this,e),this.x=n,this.y=t}return _createClass(e,[{key:"normalizeForDimensions",value:function(e,n){this.x%=e,this.y%=n,this.x<0&&(this.x=e+this.x),this.y<0&&(this.y=n+this.y)}},{key:"clone",value:function(){return new e(this.x,this.y)}}]),e}(),CellCollection:function e(){_classCallCheck(this,e),this._cells=[]}}}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.FoodController=function(){var e=SnakeGame.Consts,n=e.MAX_CYCLE_BETWEEN_FOOD,t=e.MAX_FOOD,o=e.MAX_FOOD_DURATION,r=e.MIN_FOOD_DURATION,i=SnakeGame.Utils.randomInt,a=SnakeGame.Classes.Position,s=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.className="food",e}return _inherits(n,e),n}(a);return function(){function e(){_classCallCheck(this,e),this.config={maxFood:t,maxCycleBetweenFood:n,maxDuration:o,minDuration:r},this.food=[]}return _createClass(e,[{key:"destroyOldFood",value:function(){var e=this;return this.food.reduce(function(n,t,o){return 0==--t.duration&&(e.food.splice(o,1),n.push(t)),n},[])}},{key:"generateNewFood",value:function(e){if(this.shouldGenerateFood()){var n=e();if(n){var t=new s(n.x,n.y);return t.duration=i(this.config.minDuration,this.config.maxDuration),this.food.push(t),t}}return!1}},{key:"removeFoodUnitAt",value:function(e){for(var n=this.food,t=0;t<n.length;t++)if(n[t].x===e.x&&n[t].y===e.y)return n.splice(n.indexOf(n[t]),1),!0;return!1}},{key:"getPositions",value:function(){return this.food}},{key:"shouldGenerateFood",value:function(){return this.food.length<this.config.maxFood&&Math.random()<=1/this.config.maxCycleBetweenFood}}]),e}()}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Grid=function(){var e=SnakeGame.Consts.EMPTY_CELL,n=SnakeGame.Classes.Position,t=SnakeGame.Utils,o=t.randomInt,r=t.pickRandom;return function(){function t(n,o){_classCallCheck(this,t),this.width=n,this.height=o;for(var r={},i=0;i<o;i++){r[i]={};for(var a=0;a<n;a++)r[i][a]=e}this._grid=r}return _createClass(t,[{key:"setCell",value:function(e,n){this._grid[e.y][e.x]=n}},{key:"getCell",value:function(e){return this._grid[e.y][e.x]}},{key:"getRandomEmptyPosition",value:function(){for(var t=void 0,i=0;i<5;i++)if(t=new n(o(0,this.width),o(0,this.height)),this.getCell(t)===e)return t;var a=this._grid;return r(Object.keys(a).reduce(function(t,o){var r=[];return Object.keys(a[o]).forEach(function(t){a[o][t]===e&&r.push(new n(t,o))}),t.concat(r)},[]))}}]),t}()}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.Snake=function(){var e=window.SnakeGame,n=e.Enums.Direction,t=e.Classes,o=t.Position,r=t.CellCollection,i={};i[n.UP]=n.LEFT,i[n.LEFT]=n.DOWN,i[n.DOWN]=n.RIGHT,i[n.RIGHT]=n.UP;var a={};a[n.UP]=n.RIGHT,a[n.RIGHT]=n.DOWN,a[n.DOWN]=n.LEFT,a[n.LEFT]=n.UP;var s=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.className="snake",e}return _inherits(n,e),n}(o);return function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o._cells.push(new s(e.x,e.y)),o._direction=n,o._stomach=[],o._scheduledDirectionChanges=[],o.alive=!0,o.score=0,o}return _inherits(t,e),_createClass(t,[{key:"isValidDirectionChange",value:function(e){var t=this._direction;return e&&(e===n.UP&&t!==n.DOWN||e===n.DOWN&&t!==n.UP||e===n.RIGHT&&t!==n.LEFT||e===n.LEFT&&t!==n.RIGHT)}},{key:"updateDirection",value:function(){var e=this._scheduledDirectionChanges,n=void 0,t=void 0;do{n=e.shift(),t=this.isValidDirectionChange(n)}while(!t&&e.length>0);t&&(this._direction=n)}},{key:"scheduleDirectionChange",value:function(e){var t=e;e===n.RELATIVE_LEFT?t=i[this._direction]:e===n.RELATIVE_RIGHT&&(t=a[this._direction]),this._scheduledDirectionChanges.push(t)}},{key:"getTailPosition",value:function(){return this._cells[this._cells.length-1]}},{key:"getHeadPosition",value:function(){return this._cells[0]}},{key:"getPositions",value:function(){return this._cells}},{key:"getLength",value:function(){return this._cells.length}},{key:"moveInsideOfDimensions",value:function(e,t){for(var o=this._cells,r=this._direction,i=o.length-1;i>0;i--)o[i]=o[i-1].clone();var a=o[0].clone();r===n.RIGHT?a.x++:r===n.LEFT?a.x--:r===n.UP?a.y--:r===n.DOWN&&a.y++,a.normalizeForDimensions(e,t),o[0]=a}},{key:"addCellAt",value:function(e){this._cells.push(new s(e.x,e.y))}},{key:"feed",value:function(){var e=this.getHeadPosition();return this._stomach.push({processCycle:this.getLength(),position:e.clone()}),e}},{key:"processFood",value:function(){var e=this;this._stomach.forEach(function(n){0==--n.processCycle&&(e.addCellAt(n.position),e._stomach.splice(e._stomach.indexOf(n),1))})}},{key:"setCollision",value:function(e){this.collision=e}},{key:"getCollision",value:function(){return this.collision}},{key:"kill",value:function(){this.alive=!1}},{key:"isAlive",value:function(){return this.alive}}]),t}(r)}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.BotSnake=function(){var e=SnakeGame.Utils.getRandomNonRelativeDirection;return function(n){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e.name="BOT",e}return _inherits(t,n),_createClass(t,[{key:"decideOnNextMove",value:function(){Math.random()>.8&&this.scheduleDirectionChange(e())}}]),t}(SnakeGame.Snake)}();var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();SnakeGame.PlayerSnake=function(){return function(e){function n(e,t,o){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,o));return r.name=e,r}return _inherits(n,e),_createClass(n,[{key:"getInputHandler",value:function(){var e=this;return function(n){return e.scheduleDirectionChange(n)}}}]),n}(SnakeGame.Snake)}(),SnakeGame.Canvas=function(){function e(){l.style.width=f*i+"px",l.style.height=h*i+"px";for(var e=document.createDocumentFragment(),n=0;n<h;n++){var t=document.createElement("div");t.classList.add("cell-row"),d[n]={};for(var o=0;o<f;o++){var r=document.createElement("div");d[n][o]={x:o,y:n,el:r,state:u},r.classList.add("cell"),r.style.width=i+"px",r.style.height=i+"px",t.appendChild(r)}e.appendChild(t)}l.appendChild(e)}function n(e){function n(){t%=100,++t%a==0&&e(),window.requestAnimationFrame(n)}var t=0;window.requestAnimationFrame(n)}function t(e,n,t,o){var r=d[n][e];r.renderCycle=o,r.state!==t&&(r.el.classList.remove(r.state),r.state=t,r.el.classList.add(t),t!==u?p.push(r):p.splice(p.indexOf(r),1))}function o(e){_++,_%=2;for(var n=e.snakes,o=0;o<n.length;o++)for(var r=n[o].getPositions(),i=0;i<r.length;i++)t(r[i].x,r[i].y,s,_);for(var a=e.food.getPositions(),l=0;l<a.length;l++)t(a[l].x,a[l].y,c,_);for(var f=p.slice(),h=0;h<f.length;h++)f[h].renderCycle!==_&&t(f[h].x,f[h].y,u,_)}var r=SnakeGame.Consts,i=r.CELL_SIZE,a=r.FRAME_RATE_DROP,s=r.SNAKE_CELL,u=r.EMPTY_CELL,c=r.FOOD_CELL,l=document.querySelector(".canvas"),f=Math.floor(l.getBoundingClientRect().width/i),h=Math.floor(l.getBoundingClientRect().height/i),d={},p=[],_=0;return{init:e,startFrameLoop:n,render:o,screenWidth:f,screenHeight:h}}(),SnakeGame.Game=function(){function e(e,n,t){if(t===h){var o=e.getCell(n);if(o===p)return _.SNAKE_TO_FOOD;if(o===h)return _.SNAKE_TO_SNAKE}return e.setCell(n,t),null}function n(e,n){var t=e.feed();n.removeFoodUnitAt(t),e.score++}function t(e){e.processFood()}function o(n,t){e(n,t.getTailPosition(),d),t.moveInsideOfDimensions(n.width,n.height),t.setCollision(e(n,t.getHeadPosition(),h))}function r(e){e.kill()}function i(e,t){var o=e.getCollision();o===_.SNAKE_TO_FOOD?n(e,t):o===_.SNAKE_TO_SNAKE&&r(e)}function a(n,t){t.destroyOldFood();var o=t.generateNewFood(function(){return n.getRandomEmptyPosition()});o&&e(n,o,p)}function s(e){e.updateDirection()}function u(e,n,t){e.decideOnNextMove(n,t)}function c(e,n){e.filter(function(e){return e.isAlive()}).length<=1&&n()}function l(e,n,r){function l(){p.forEach(function(e){return u(e,f,h)}),d.forEach(function(e){return s(e)}),d.forEach(function(e){return o(f,e)}),d.forEach(function(e){return i(e,h)}),d.forEach(function(e){return t(e)}),c(d,r),a(f,h)}var f=new E(e,n),h=new k,d=[new g(y(),f.getRandomEmptyPosition(),m()),new C(f.getRandomEmptyPosition(),m())],p=d.filter(function(e){return e instanceof C}),_=d.filter(function(e){return e instanceof g}),v=_.map(function(e){return e.getInputHandler()});return{snakes:d,botSnakes:p,playerSnakes:_,food:h,frameLoop:l,inputMoveHandlers:v}}var f=SnakeGame.Consts,h=f.SNAKE_CELL,d=f.EMPTY_CELL,p=f.FOOD_CELL,_=SnakeGame.Enums.Collision,v=SnakeGame.Utils,m=v.getRandomNonRelativeDirection,y=v.getRandomName,E=SnakeGame.Grid,g=SnakeGame.PlayerSnake,C=SnakeGame.BotSnake,k=SnakeGame.FoodController;return l}(),SnakeGame.Ui=function(){function e(e,n,t){e.classList[t?"add":"remove"](n)}function n(e){l!==e&&(l=e,h.statsScore.textContent=l)}function t(){f.trigger(c.PAUSE),d.toggle(h.menu)}function o(){window.location.reload()}function r(){h.body.removeEventListener("keydown",r),d.hide(h.gameStartPopup),f.trigger(c.START)}function i(e,n,t){h.gameEndPopupScoreValue.textContent=t,h.gameEndPopupTitle.textContent=e+", you "+(n?"rule":"suck")+"!",d.show(h.gameEndPopup)}var a=window.document,s=SnakeGame.Evented,u=SnakeGame.Consts,c={RELATIVE_LEFT:"relative-left",RELATIVE_RIGHT:"relative-right",PAUSE:"pause",UP:"keydown-arrow-up",DOWN:"keydown-arrow-down",LEFT:"keydown-arrow-left",RIGHT:"keydown-arrow-right",START:"start"},l=void 0,f=s({}),h=Array.prototype.slice.call(a.querySelectorAll("[js]")).reduce(function(e,n){return e[n.getAttribute("js")]=n,e},{}),d=function(){function n(n){i||(e(n,"is-shown",!0),e(h.body,"is-popup-shown",!0),i=n)}function t(){i&&(e(i,"is-shown",!1),e(h.body,"is-popup-shown",!1),i=null)}function o(e){return i?t():n(e)}function r(e){return i===e}var i=null;return{show:n,hide:t,toggle:o,isShown:r}}();return h.body.addEventListener("keydown",r),h.mobileControlLeft.addEventListener("touchstart",function(){return f.trigger(c.RELATIVE_LEFT)}),h.mobileControlRight.addEventListener("touchstart",function(){return f.trigger(c.RELATIVE_RIGHT)}),h.mobileControlMenu.addEventListener("click",t),h.gameEndPopupNewGameButton.addEventListener("click",o),h.gameStartPopupStartGameButton.addEventListener("click",r),a.addEventListener("keydown",function(e){40===e.which?f.trigger(c.DOWN):39===e.which?f.trigger(c.RIGHT):38===e.which?f.trigger(c.UP):37===e.which?f.trigger(c.LEFT):80===e.which&&t()}),function(){h.menuInputSize.value=u.CELL_SIZE,h.menuInputSpeed.value=u.FRAME_RATE_DROP,h.menuInputFood.value=u.MAX_FOOD}(),d.show(h.gameStartPopup),Object.assign(f,{UiEvent:c,updateStats:n,showGameEndPopup:i})}(),function(){var e=SnakeGame.Canvas,n=e.screenWidth,t=e.screenHeight,o=e.render,r=e.init,i=e.startFrameLoop,a=SnakeGame.Enums.Direction,s=SnakeGame.Game,u=SnakeGame.Ui,c=u.UiEvent;u.on(c.START,function(){function e(){l=!l,document.body.classList[l?"add":"remove"]("is-game-paused")}var l=!1,f=!1;r();var h=s(n,t,function(){f=!0,l=!0,u.off();var e=h.playerSnakes[0];u.showGameEndPopup(e.name,e.isAlive(),e.score)});u.on(c.PAUSE,function(){return e()}),u.on(c.RELATIVE_LEFT,function(){return h.inputMoveHandlers[0](a.RELATIVE_LEFT)}),u.on(c.RELATIVE_RIGHT,function(){return h.inputMoveHandlers[0](a.RELATIVE_RIGHT)}),u.on(c.DOWN,function(){return h.inputMoveHandlers[0](a.DOWN)}),u.on(c.RIGHT,function(){return h.inputMoveHandlers[0](a.RIGHT)}),u.on(c.UP,function(){return h.inputMoveHandlers[0](a.UP)}),u.on(c.LEFT,function(){return h.inputMoveHandlers[0](a.LEFT)}),i(function(){l||f||(h.frameLoop(),u.updateStats(h.playerSnakes[0].score),o(h))})})}();